<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Débogage Upload Vidéo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; text-align: center; }
        .step { border: 1px solid #ddd; margin: 15px 0; padding: 15px; border-radius: 5px; }
        .step h2 { margin-top: 0; color: #4CAF50; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; }
        input, select { margin: 10px 0; padding: 8px; width: 100%; box-sizing: border-box; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .logs { height: 150px; overflow-y: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Débogage Upload Vidéo</h1>

    <div class="step">
        <h2>1. Obtenir un token JWT</h2>
        <button onclick="getToken()">Obtenir un token</button>
        <div id="tokenResult"></div>
    </div>

    <div class="step">
        <h2>2. Tester le fichier vidéo</h2>
        <input type="file" id="videoFile" accept="video/*" onchange="analyzeVideo()">
        <div id="videoAnalysis"></div>
    </div>

    <div class="step">
        <h2>3. Upload de la vidéo</h2>
        <div>
            <input type="text" id="content" value="Test vidéo debug" placeholder="Contenu du post">
            <select id="visibility">
                <option value="public">Public</option>
                <option value="private">Privé</option>
            </select>
            <button onclick="uploadVideo()">Uploader la vidéo</button>
        </div>
        <div id="uploadResult"></div>
    </div>

    <div class="step">
        <h2>4. Mode debug</h2>
        <button onclick="checkDebugMode()">Vérifier le mode du serveur</button>
        <div id="debugResult"></div>
    </div>

    <script>
        // Variables globales
        let token = '';
        const BASE_URL = 'http://localhost:8080';

        // Fonction pour afficher les résultats
        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            let content = '';

            if (isError) {
                content = `<p class="error">ERREUR: ${JSON.stringify(data)}</p>`;
            } else {
                content = `<p class="success">SUCCÈS!</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }

            element.innerHTML = content;
        }

        // 1. Obtenir un token JWT
        async function getToken() {
            try {
                document.getElementById('tokenResult').innerHTML = "<p>Récupération du token...</p>";

                const response = await fetch(`${BASE_URL}/api/fake-login`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    showResult('tokenResult', data);
                } else {
                    showResult('tokenResult', data, true);
                }
            } catch (error) {
                showResult('tokenResult', error.message, true);
            }
        }

        // 2. Analyser le fichier vidéo
        function analyzeVideo() {
            const fileInput = document.getElementById('videoFile');
            const analysisDiv = document.getElementById('videoAnalysis');

            if (!fileInput.files || fileInput.files.length === 0) {
                analysisDiv.innerHTML = "<p class='error'>Aucun fichier sélectionné</p>";
                return;
            }

            const file = fileInput.files[0];
            const extension = file.name.split('.').pop().toLowerCase();
            const validExtensions = ['mp4', 'mov', 'webm'];
            const isValidExt = validExtensions.includes(extension);
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);

            let html = "<h3>Analyse du fichier</h3>";
            html += "<table>";
            html += `<tr><th>Propriété</th><th>Valeur</th><th>Statut</th></tr>`;
            html += `<tr><td>Nom</td><td>${file.name}</td><td></td></tr>`;
            html += `<tr><td>Type MIME</td><td>${file.type}</td><td></td></tr>`;
            html += `<tr><td>Extension</td><td>.${extension}</td><td>${isValidExt ? '<span class="success">✓</span>' : '<span class="error">✗ Extension non valide</span>'}</td></tr>`;
            html += `<tr><td>Taille</td><td>${sizeInMB} MB</td><td>${sizeInMB <= 100 ? '<span class="success">✓</span>' : '<span class="error">✗ Trop volumineux</span>'}</td></tr>`;
            html += "</table>";

            // Vérification globale
            if (isValidExt && sizeInMB <= 100) {
                html += "<p class='success'>✅ Ce fichier devrait être accepté par le serveur</p>";
            } else {
                html += "<p class='error'>❌ Ce fichier sera probablement rejeté par le serveur</p>";
                if (!isValidExt) html += "<p>L'extension doit être .mp4, .mov ou .webm</p>";
                if (sizeInMB > 100) html += "<p>La taille maximum autorisée est de 100 MB</p>";
            }

            analysisDiv.innerHTML = html;
        }

        // 3. Upload de la vidéo
        async function uploadVideo() {
            if (!token) {
                showResult('uploadResult', 'Veuillez d\'abord obtenir un token', true);
                return;
            }

            const fileInput = document.getElementById('videoFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                showResult('uploadResult', 'Sélectionnez une vidéo', true);
                return;
            }

            const content = document.getElementById('content').value;
            const visibility = document.getElementById('visibility').value;
            const uploadResultDiv = document.getElementById('uploadResult');

            uploadResultDiv.innerHTML = "<p>Upload en cours... Veuillez patienter.</p>";

            try {
                const formData = new FormData();
                formData.append('content', content);
                formData.append('visibility', visibility);
                formData.append('video', fileInput.files[0]);

                const response = await fetch(`${BASE_URL}/api/posts`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('uploadResult', data);
                } else {
                    showResult('uploadResult', data, true);
                }
            } catch (error) {
                showResult('uploadResult', error.message, true);
            }
        }

        // 4. Vérifier le mode debug
        async function checkDebugMode() {
            try {
                const response = await fetch(`${BASE_URL}/debug/mode`);
                const data = await response.json();
                showResult('debugResult', data);
            } catch (error) {
                showResult('debugResult', error.message, true);
            }
        }
    </script>
</body>
</html>
