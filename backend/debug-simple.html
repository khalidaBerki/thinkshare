<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Simple Upload</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: 20px auto; padding: 20px; }
        h1 { color: #333; text-align: center; }
        div { margin: 15px 0; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 15px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 4px; height: 200px; overflow: auto; white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Test Simple Upload</h1>

    <div>
        <p>1. Obtenir un token:</p>
        <button onclick="getToken()">Générer Token</button>
    </div>

    <div>
        <p>2. Sélectionner une vidéo:</p>
        <input type="file" id="videoFile" accept="video/*">
    </div>

    <div>
        <p>3. Uploader:</p>
        <button onclick="uploadVideo()">Envoyer</button>
    </div>

    <div>
        <p>Logs:</p>
        <div id="logs" class="log"></div>
    </div>

    <script>
        let token = '';
        const logElement = document.getElementById('logs');

        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${message}`;

            if (isError) {
                logElement.innerHTML += `<span style="color: red">${line}</span>\n`;
            } else {
                logElement.innerHTML += `${line}\n`;
            }

            logElement.scrollTop = logElement.scrollHeight;
        }

        async function getToken() {
            log('Récupération du token...');

            try {
                const response = await fetch('http://localhost:8080/api/fake-login', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    log(`Token obtenu avec succès! (${token.substring(0, 15)}...)`)
                } else {
                    log(`Erreur: ${JSON.stringify(data)}`, true);
                }
            } catch (error) {
                log(`Erreur: ${error.message}`, true);
            }
        }

        async function uploadVideo() {
            if (!token) {
                log('Erreur: Veuillez d\'abord générer un token', true);
                return;
            }

            const fileInput = document.getElementById('videoFile');
            if (!fileInput.files || fileInput.files.length === 0) {
                log('Erreur: Sélectionnez une vidéo', true);
                return;
            }

            const file = fileInput.files[0];
            log(`Début upload vidéo: ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)`);

            const formData = new FormData();
            formData.append('content', 'Test vidéo depuis debug-simple.html');
            formData.append('visibility', 'public');
            formData.append('video', file);

            try {
                log('Envoi de la requête...');

                const response = await fetch('http://localhost:8080/api/posts', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                log(`Statut de la réponse: ${response.status} ${response.statusText}`);

                const data = await response.json();

                if (response.ok) {
                    log('Upload réussi!');
                    log(JSON.stringify(data, null, 2));
                } else {
                    log(`Erreur: ${JSON.stringify(data)}`, true);
                }
            } catch (error) {
                log(`Erreur: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>
